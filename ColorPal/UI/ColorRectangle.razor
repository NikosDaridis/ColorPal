<span class=@GetClass()
      style="background-color: @HEXColor;"
      data-color=@HEXColor
      id=@($"colorRectangle{(IsSelected ? "-active" : string.Empty)}")
      draggable=@(ActiveColorTool == ColorToolType.Move ? "true" : "false")
      @onclick=HandleOnClickAsync>

    @if (ActiveColorTool == ColorToolType.TintsShades && TintsShadesIndex is not null)
    {
        <h4 class="absolute bottom-0 left-1/2 transform -translate-x-1/2 text-[8px] font-semibold"
            style="color: @(TintsShadesIndex <= 40 ? "white" : "black");">
            @TintsShadesIndex
        </h4>
    }
    else
    {
        <img class="w-[60%]"
             src=@GetImgSrc()
             draggable="false" />
    }
</span>

@code {
    [Parameter]
    public string HEXColor { get; set; } = "ffffff";

    [Parameter]
    public bool IsSelected { get; set; }

    [Parameter]
    public int? TintsShadesIndex { get; set; }

    [Parameter]
    public ColorToolType ActiveColorTool { get; set; }

    [Parameter]
    public LocalStorageService? LocalStorageService { get; set; }

    [Parameter]
    public EventAggregator<string>? EventAggregator { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
    }

    public async Task HandleOnClickAsync(MouseEventArgs args)
    {
        if (EventAggregator is null)
            return;

        await EventAggregator.GetService(Event.SetSelectedColor).PublishAsync(HEXColor);

        if (ActiveColorTool == ColorToolType.Delete)
            await DeleteSavedColor();

        if (ActiveColorTool == ColorToolType.TintsShades)
            await EventAggregator.GetService(Event.RenderTintsShades).PublishAsync(HEXColor);
    }

    private string GetClass()
    {
        string baseClass = "aspect-square relative flex justify-center items-center cursor-pointer transition-all duration-200 hover:scale-[1.1] hover:ring-[var(--primary-color)]";
        string shapeClass = IsSelected ? "rounded-xl" : "rounded-md";
        string ringClass = IsSelected
            ? "ring-2 ring-[var(--selected-color)]"
            : ActiveColorTool switch
            {
                ColorToolType.Move => "ring-1 ring-[var(--move-tool-color)]",
                ColorToolType.TintsShades => "ring-1 ring-[var(--tintsshades-tool-color)]",
                ColorToolType.Delete => "ring-1 ring-[var(--delete-tool-color)]",
                _ => "ring-1 ring-[var(--theme-invert-color)]"
            };

        return $"{baseClass} {shapeClass} {ringClass}";
    }

    private string GetImgSrc() =>
        ActiveColorTool switch
        {
            ColorToolType.Move => "Icons/move.svg",
            ColorToolType.TintsShades => "Icons/tintsShades.svg",
            ColorToolType.Delete => "Icons/delete.svg",
            _ => string.Empty
        };

    private async Task<bool> DeleteSavedColor()
    {
        if (LocalStorageService is null || EventAggregator is null)
            return false;

        string[] savedColors = await LocalStorageService.GetKeyAsync<string[]>(StorageKey.SavedColorsArray) ?? [];

        if (!savedColors.Contains(HEXColor))
            return false;

        savedColors = savedColors.Where(color => color != HEXColor).ToArray();

        await LocalStorageService.SetKeyAsync(StorageKey.SavedColorsArray, savedColors);
        await EventAggregator.GetService(Event.DeleteSavedColor).PublishAsync(HEXColor);

        return true;
    }
}
